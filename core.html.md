# core


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

# Automated Backups

We want a script to back up a specific file/folder over different
intervals. Specifically, it should

- Copy to some destination dir every hour (e.g. a different drive)
- Keep the last 5, and one every day, week and month (for example)

We can then rsync the destination dir to keep a remote backup.

``` python
!mkdir -p demo_src
!mkdir -p demo_dst
!rm -r demo_dst/*
```

``` python
!echo "content" > "demo_src/$(date +%s).txt"
```

## The core functionality

The plan has two main steps:

- Create a new backup
- Clean up any old backups that are no longer needed.

Step 1 is easy enough:

------------------------------------------------------------------------

<a
href="https://github.com/johnowhitaker/autobackup/blob/main/autobackup/core.py#L15"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_backup

>      create_backup (src, dest_dir)

``` python
create_backup('demo_src', 'demo_dst')
!ls demo_dst
```

    20241115_120316

The harder part is the cleanup. Let’s start by generating some dates to
test with.

``` python
def generate_test_dates(num_dates, base_date):
    return [(base_date + timedelta(hours=i)).strftime("%Y%m%d_%H%M%S") for i in range(num_dates)]
test_dates = generate_test_dates(2400, datetime.now() - timedelta(days=100))
print(test_dates[:5], test_dates[-5:])
```

    ['20240807_120317', '20240807_130317', '20240807_140317', '20240807_150317', '20240807_160317'] ['20241115_070317', '20241115_080317', '20241115_090317', '20241115_100317', '20241115_110317']

``` python
# Can I get all dates < 2 months old?
[d for d in test_dates if (datetime.now() - datetime.strptime(d, '%Y%m%d_%H%M%S')).days < 60][:3]
```

    ['20240916_130317', '20240916_140317', '20240916_150317']

Now we want to grab the most recent 5, and then the oldest below some
threshold.

------------------------------------------------------------------------

<a
href="https://github.com/johnowhitaker/autobackup/blob/main/autobackup/core.py#L25"
target="_blank" style="float:right; font-size:smaller">source</a>

### clean_dates

>      clean_dates (dates, now=None, max_ages=(2, 14, 60))

``` python
clean_dates(test_dates)
```

    ['20240916_130317',
     '20241101_130317',
     '20241113_130317',
     '20241115_070317',
     '20241115_080317',
     '20241115_090317',
     '20241115_100317',
     '20241115_110317']

Now we want code that starts with the same test dates etc as above, but
then simulates time passing by adding an hour to ‘now’ and a date to
test dates every step then printing out a (prettified) version of
clean_dates to check it’s doing as I expect over a simulated month.

``` python
# Initialize
now = datetime.now()
test_dates = generate_test_dates(2400, now - timedelta(days=100))

# Simulate time passing
for _ in range(30 * 24):  # Simulate a month (30 days * 24 hours)
    now += timedelta(hours=1)
    test_dates.append(now.strftime("%Y%m%d_%H%M%S"))
    test_dates = clean_dates(test_dates, now)  # Clean up old dates
    if _ % 24 == 0:  # Print once a day
        print(f"\nDay {_ // 24 + 1}:")
        pprint.pprint(test_dates)
```


    Day 1:
    ['20240916_140322',
     '20241101_140322',
     '20241113_140322',
     '20241115_080322',
     '20241115_090322',
     '20241115_100322',
     '20241115_110322',
     '20241115_130322']

    Day 2:
    ['20241101_140322',
     '20241113_140322',
     '20241115_080322',
     '20241116_090322',
     '20241116_100322',
     '20241116_110322',
     '20241116_120322',
     '20241116_130322']

    Day 3:
    ['20241101_140322',
     '20241113_140322',
     '20241117_030322',
     '20241117_090322',
     '20241117_100322',
     '20241117_110322',
     '20241117_120322',
     '20241117_130322']

    Day 4:
    ['20241101_140322',
     '20241113_140322',
     '20241117_030322',
     '20241118_090322',
     '20241118_100322',
     '20241118_110322',
     '20241118_120322',
     '20241118_130322']

    Day 5:
    ['20241101_140322',
     '20241113_140322',
     '20241118_220322',
     '20241119_090322',
     '20241119_100322',
     '20241119_110322',
     '20241119_120322',
     '20241119_130322']

    Day 6:
    ['20241101_140322',
     '20241113_140322',
     '20241118_220322',
     '20241120_090322',
     '20241120_100322',
     '20241120_110322',
     '20241120_120322',
     '20241120_130322']

    Day 7:
    ['20241101_140322',
     '20241113_140322',
     '20241120_170322',
     '20241121_090322',
     '20241121_100322',
     '20241121_110322',
     '20241121_120322',
     '20241121_130322']

    Day 8:
    ['20241101_140322',
     '20241113_140322',
     '20241120_170322',
     '20241122_090322',
     '20241122_100322',
     '20241122_110322',
     '20241122_120322',
     '20241122_130322']

    Day 9:
    ['20241101_140322',
     '20241113_140322',
     '20241122_120322',
     '20241123_090322',
     '20241123_100322',
     '20241123_110322',
     '20241123_120322',
     '20241123_130322']

    Day 10:
    ['20241101_140322',
     '20241113_140322',
     '20241124_070322',
     '20241124_090322',
     '20241124_100322',
     '20241124_110322',
     '20241124_120322',
     '20241124_130322']

    Day 11:
    ['20241101_140322',
     '20241113_140322',
     '20241124_070322',
     '20241125_090322',
     '20241125_100322',
     '20241125_110322',
     '20241125_120322',
     '20241125_130322']

    Day 12:
    ['20241101_140322',
     '20241113_140322',
     '20241126_020322',
     '20241126_090322',
     '20241126_100322',
     '20241126_110322',
     '20241126_120322',
     '20241126_130322']

    Day 13:
    ['20241101_140322',
     '20241113_140322',
     '20241126_020322',
     '20241127_090322',
     '20241127_100322',
     '20241127_110322',
     '20241127_120322',
     '20241127_130322']

    Day 14:
    ['20241101_140322',
     '20241126_020322',
     '20241127_210322',
     '20241128_090322',
     '20241128_100322',
     '20241128_110322',
     '20241128_120322',
     '20241128_130322']

    Day 15:
    ['20241101_140322',
     '20241126_020322',
     '20241127_210322',
     '20241129_090322',
     '20241129_100322',
     '20241129_110322',
     '20241129_120322',
     '20241129_130322']

    Day 16:
    ['20241101_140322',
     '20241126_020322',
     '20241129_160322',
     '20241130_090322',
     '20241130_100322',
     '20241130_110322',
     '20241130_120322',
     '20241130_130322']

    Day 17:
    ['20241101_140322',
     '20241126_020322',
     '20241129_160322',
     '20241201_090322',
     '20241201_100322',
     '20241201_110322',
     '20241201_120322',
     '20241201_130322']

    Day 18:
    ['20241101_140322',
     '20241126_020322',
     '20241201_110322',
     '20241202_090322',
     '20241202_100322',
     '20241202_110322',
     '20241202_120322',
     '20241202_130322']

    Day 19:
    ['20241101_140322',
     '20241126_020322',
     '20241203_060322',
     '20241203_090322',
     '20241203_100322',
     '20241203_110322',
     '20241203_120322',
     '20241203_130322']

    Day 20:
    ['20241101_140322',
     '20241126_020322',
     '20241203_060322',
     '20241204_090322',
     '20241204_100322',
     '20241204_110322',
     '20241204_120322',
     '20241204_130322']

    Day 21:
    ['20241101_140322',
     '20241126_020322',
     '20241205_010322',
     '20241205_090322',
     '20241205_100322',
     '20241205_110322',
     '20241205_120322',
     '20241205_130322']

    Day 22:
    ['20241101_140322',
     '20241126_020322',
     '20241205_010322',
     '20241206_090322',
     '20241206_100322',
     '20241206_110322',
     '20241206_120322',
     '20241206_130322']

    Day 23:
    ['20241101_140322',
     '20241126_020322',
     '20241206_200322',
     '20241207_090322',
     '20241207_100322',
     '20241207_110322',
     '20241207_120322',
     '20241207_130322']

    Day 24:
    ['20241101_140322',
     '20241126_020322',
     '20241206_200322',
     '20241208_090322',
     '20241208_100322',
     '20241208_110322',
     '20241208_120322',
     '20241208_130322']

    Day 25:
    ['20241101_140322',
     '20241126_020322',
     '20241208_150322',
     '20241209_090322',
     '20241209_100322',
     '20241209_110322',
     '20241209_120322',
     '20241209_130322']

    Day 26:
    ['20241101_140322',
     '20241208_150322',
     '20241210_090322',
     '20241210_100322',
     '20241210_110322',
     '20241210_120322',
     '20241210_130322']

    Day 27:
    ['20241101_140322',
     '20241208_150322',
     '20241210_100322',
     '20241211_090322',
     '20241211_100322',
     '20241211_110322',
     '20241211_120322',
     '20241211_130322']

    Day 28:
    ['20241101_140322',
     '20241208_150322',
     '20241212_050322',
     '20241212_090322',
     '20241212_100322',
     '20241212_110322',
     '20241212_120322',
     '20241212_130322']

    Day 29:
    ['20241101_140322',
     '20241208_150322',
     '20241212_050322',
     '20241213_090322',
     '20241213_100322',
     '20241213_110322',
     '20241213_120322',
     '20241213_130322']

    Day 30:
    ['20241101_140322',
     '20241208_150322',
     '20241214_000322',
     '20241214_090322',
     '20241214_100322',
     '20241214_110322',
     '20241214_120322',
     '20241214_130322']

NB: Yay, it looks to be doing mostly what I want! I can collapse the
output, if you’re viewing this in a notebook my apologies :)

## Turning it into a script

Now that those two pieces of functionality seem to be working, we can
wrap this up as a script using fastcore’s call_parse, have it run the
backup, clean up old files, and log any errors or messages to backup.log

------------------------------------------------------------------------

<a
href="https://github.com/johnowhitaker/autobackup/blob/main/autobackup/core.py#L39"
target="_blank" style="float:right; font-size:smaller">source</a>

### run_backup

>      run_backup (src:str, dest:str, max_ages:str='2,14,60',
>                  log_file:str='backup.log')

*Run backup and cleanup old files*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>src</td>
<td>str</td>
<td></td>
<td>The source to be backed up</td>
</tr>
<tr class="even">
<td>dest</td>
<td>str</td>
<td></td>
<td>The destination directory</td>
</tr>
<tr class="odd">
<td>max_ages</td>
<td>str</td>
<td>2,14,60</td>
<td>The max age(s) in days for the different backups</td>
</tr>
<tr class="even">
<td>log_file</td>
<td>str</td>
<td>backup.log</td>
<td></td>
</tr>
</tbody>
</table>

``` python
!ls demo_src
```

    1731699240.txt  1731700528.txt  1731700920.txt
    1731700503.txt  1731700856.txt  1731700993.txt

Testing a directory:

``` python
!rm -r demo_dst/*
```

``` python
run_backup('demo_src', 'demo_dst',)
!ls demo_dst
```

    20241115_120331

``` python
!ls demo_dst/20241115_120331
```

    1731699240.txt  1731700528.txt  1731700920.txt
    1731700503.txt  1731700856.txt  1731700993.txt

Testing a single file

``` python
!rm -r demo_dst/*
```

``` python
run_backup('demo_src/1731700503.txt', 'demo_dst')
```

``` python
!ls demo_dst
```

    20241115_120341

``` python
!ls demo_dst/20241115_120341
```

    1731700503.txt
